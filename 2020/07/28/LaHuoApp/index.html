<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="注意 此文仅限于技术交流，请不要做违法的事情。对于那些居心叵测的人根据此文造成违法的事情与本人无关。此文章不得转载！！！ 关键图片信息已打码，关键代码信息已用XXOO替代。如果APP方需要删除，请发邮件zhulongfei28@gmail.com，谢谢。 这并不是基础教程，需要一定iOS逆向经验的人才能看懂。  准备 ida反汇编mach-o文件 class-dump头文件 Reveal查看APP">
<meta name="keywords" content="逆向,iOS">
<meta property="og:type" content="article">
<meta property="og:title" content="逆向某拉货APP登录过程">
<meta property="og:url" content="http://yoursite.com/2020/07/28/LaHuoApp/index.html">
<meta property="og:site_name" content="龙龙的技术博客">
<meta property="og:description" content="注意 此文仅限于技术交流，请不要做违法的事情。对于那些居心叵测的人根据此文造成违法的事情与本人无关。此文章不得转载！！！ 关键图片信息已打码，关键代码信息已用XXOO替代。如果APP方需要删除，请发邮件zhulongfei28@gmail.com，谢谢。 这并不是基础教程，需要一定iOS逆向经验的人才能看懂。  准备 ida反汇编mach-o文件 class-dump头文件 Reveal查看APP">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/LaHuoApp-01.png">
<meta property="og:updated_time" content="2020-07-28T13:59:18.845Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="逆向某拉货APP登录过程">
<meta name="twitter:description" content="注意 此文仅限于技术交流，请不要做违法的事情。对于那些居心叵测的人根据此文造成违法的事情与本人无关。此文章不得转载！！！ 关键图片信息已打码，关键代码信息已用XXOO替代。如果APP方需要删除，请发邮件zhulongfei28@gmail.com，谢谢。 这并不是基础教程，需要一定iOS逆向经验的人才能看懂。  准备 ida反汇编mach-o文件 class-dump头文件 Reveal查看APP">
<meta name="twitter:image" content="http://yoursite.com/images/LaHuoApp-01.png">

<link rel="canonical" href="http://yoursite.com/2020/07/28/LaHuoApp/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>逆向某拉货APP登录过程 | 龙龙的技术博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">龙龙的技术博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/28/LaHuoApp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="龙龙的技术博客,各种IT知识的聚合">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="龙龙的技术博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          逆向某拉货APP登录过程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-28 21:59:18" itemprop="dateCreated datePublished" datetime="2020-07-28T21:59:18+08:00">2020-07-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS逆向/" itemprop="url" rel="index"><span itemprop="name">iOS逆向</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ul>
<li>此文仅限于技术交流，请不要做违法的事情。对于那些居心叵测的人根据此文造成违法的事情与本人无关。此文章不得转载！！！</li>
<li>关键图片信息已打码，关键代码信息已用XXOO替代。如果APP方需要删除，请发邮件<code>zhulongfei28@gmail.com</code>，谢谢。</li>
<li>这并不是基础教程，需要一定iOS逆向经验的人才能看懂。</li>
</ul>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul>
<li>ida反汇编mach-o文件</li>
<li>class-dump头文件</li>
<li>Reveal查看APP层级视图</li>
<li>Theos编写tweak插件</li>
<li><code>Charles</code>+<code>SSL Kill Switch 2</code>https抓包</li>
<li>Frida Hook框架</li>
</ul>
<a id="more"></a>

<h2 id="寻找切入点"><a href="#寻找切入点" class="headerlink" title="寻找切入点"></a>寻找切入点</h2><ul>
<li><p>App切换到<code>使用账号密码登录</code>界面，输入账号和密码，点击两次登录按钮，使用Charles查看抓包内容。<br><img src="/images/LaHuoApp-01.png" alt></p>
</li>
<li><p>可以发现<code>_sign</code>、<code>_su</code>、<code>_t</code>三个参数在变，所以接下来就是要探索这三个参数的生成过程。怎样切入呢？本文从点击登录按钮动作开始一层一层往下寻找。</p>
</li>
<li><p>使用Reveal查看发现登录按钮属于<code>PasswordLoginVC</code>这个控制器，那么登录执行的方法也在这个头文件中。遗憾的是从主mach-o导出的头文件中并没有找到<code>PasswordLoginVC.h</code>，那么肯定是在其它模块中包含的。怎样寻找哪个模块包含<code>PasswordLoginVC</code>这个类呢，可以使用LLDB。</p>
</li>
<li><p>LLDB连接上后执行<code>image lookup -r -n PasswordLoginVC</code>，发现在<code>HLLCommonModule</code>这个模块中。根据经验可知，从<code>.app/Frameworks</code>中可以找到这个模块的mach-o文件，然后使用class-dump导出头文件。</p>
</li>
<li><p>打开<code>PasswordLoginVC.h</code>经过排除，以下几个方法可能是点击登录按钮要执行的操作，所以接下来要确定是哪个方法是我们需要的。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)changePasswordLogin;	<span class="comment">// IMP=0x000000000007e534</span></span><br><span class="line">- (<span class="keyword">void</span>)fieldChangeAction:(<span class="keyword">id</span>)arg1;	<span class="comment">// IMP=0x000000000007e27c</span></span><br><span class="line">- (<span class="keyword">void</span>)securityAction:(<span class="keyword">id</span>)arg1;	<span class="comment">// IMP=0x000000000007e1c0</span></span><br><span class="line">- (<span class="keyword">void</span>)login;	<span class="comment">// IMP=0x000000000007d400</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>mach-o没有恢复符号，可以通过地址断点给上面四个方法下断点，看会命中哪个；可以通过<code>frida-trace</code>跟踪函数调用。本文采用简单的方法，如下，发现调用了<code>login</code>方法。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> frida-trace -U -m "*[PasswordLoginVC *]" 货拉拉</span><br><span class="line">....</span><br><span class="line">30522 ms  -[PasswordLoginVC login]</span><br><span class="line">30522 ms     | -[PasswordLoginVC isAgree]</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="寻找可变参数"><a href="#寻找可变参数" class="headerlink" title="寻找可变参数"></a>寻找可变参数</h2><ul>
<li><p>把<code>HLLCommonModule</code>mach-o文件拖进IDA，分析<code>-[PasswordLoginVC login]</code>，发现最显眼的一个方法，接着在进去这个方法分析。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+[HLLCommonNetServer loginWithTel:password:currentCityId:response:]</span><br></pre></td></tr></table></figure>
</li>
<li><p>进去之后，又发现如下核心代码，还是没有我们需要的那三个参数，进去这个方法继续分析。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">v41 = ((<span class="keyword">id</span> (__cdecl *)(HLLNetRequest_meta *, SEL, <span class="keyword">id</span>, <span class="keyword">id</span>, <span class="keyword">signed</span> __int64, <span class="keyword">id</span>, <span class="keyword">id</span>, <span class="keyword">id</span>))objc_msgSend)(</span><br><span class="line">       (HLLNetRequest_meta *)&amp;OBJC_CLASS___HLLNetRequest,</span><br><span class="line">       <span class="string">"requestDataWithClass:key:type:method:params:response:"</span>,</span><br><span class="line">       (<span class="keyword">id</span>)<span class="built_in">CFSTR</span>(<span class="string">"Login"</span>),</span><br><span class="line">       <span class="number">0</span>LL,</span><br><span class="line">       <span class="number">0</span>LL,</span><br><span class="line">       (<span class="keyword">id</span>)<span class="built_in">CFSTR</span>(<span class="string">"login_by_pwd"</span>),</span><br><span class="line">       v38,</span><br><span class="line">       &amp;v47);</span><br></pre></td></tr></table></figure>
</li>
<li><p>进去<code>+[HLLNetRequest requestDataWithClass:key:type:method:params:response:]</code>发现<code>urlJoinTogetherWithPeams:method:</code>，有关键字<code>join</code>和<code>merge</code>像是在生成需要的参数</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">v28 = ((<span class="keyword">id</span> (__cdecl *)(HllUrlMergeManager_meta *, SEL, <span class="keyword">id</span>, <span class="keyword">id</span>))objc_msgSend)(</span><br><span class="line">          (HllUrlMergeManager_meta *)&amp;OBJC_CLASS___HllUrlMergeManager,</span><br><span class="line">          <span class="string">"urlJoinTogetherWithPeams:method:"</span>,</span><br><span class="line">          v17,</span><br><span class="line">          v15);</span><br></pre></td></tr></table></figure>
</li>
<li><p>我们需要<code>urlJoinTogetherWithPeams:method:</code>方法下地址断点，在方法执行后打印一下执行结果。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(lldb) image list -o -f | grep HLLCommonModule</span><br><span class="line">[  <span class="number">0</span>] <span class="number">0x0000000100a04000</span> /private/var/containers/Bundle/Application/  <span class="number">0</span>C0095F0<span class="number">-160</span>B<span class="number">-4</span>BCA<span class="number">-8</span>D91-F357CF72A295/XXOO.app/Frameworks/HLLCommonModule.framework/HLLCommonModule  (<span class="number">0x0000000100a04000</span>)</span><br><span class="line">(lldb) breakpoint set -a <span class="number">0x0000000100a04000</span>+<span class="number">0x000000000004F8D8</span></span><br><span class="line"></span><br><span class="line">(lldb) po $x0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"_su"</span> = <span class="number">20072417571221220000003299129480</span>;</span><br><span class="line">  <span class="string">"_t"</span> = <span class="number">1595584632</span>;</span><br><span class="line">  args = <span class="string">"&#123;\"password\":\"e10adc3949ba59abbe56e057f20f883e\",\"ref\":\"\",\"device_id\":\"292126F625BD47CFAB6E44162DCC85CA\",\"city_id\":1002,\"phone_no\":\"18618618618\",\"device_type\":\"iPhone 6\",\"idfa\":\"3D506F30-D4D9-49C2-A61E-EC5EF222D475\"&#125;"</span>;</span><br><span class="line">  <span class="string">"device_id"</span> = <span class="number">292126</span>F625BD47CFAB6E44162DCC85CA;</span><br><span class="line">  <span class="string">"device_type"</span> = <span class="string">"iPhone 6"</span>;</span><br><span class="line">  os = ios;</span><br><span class="line">  revision = <span class="number">6446</span>;</span><br><span class="line">  version = <span class="string">"6.4.46"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以发现<code>_su</code>和<code>-t</code>参数，我们前面提到三个可变参数，现在已经找到两个了。点击<code>+[HllUrlMergeManager urlJoinTogetherWithPeams:method:]</code>进去查看方法实现，大致浏览一遍可以发现<code>_su</code>和<code>-t</code>的生成过程。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">v22 = +[HLLGlobelManager startUUIDString](&amp;OBJC_CLASS___HLLGlobelManager, <span class="string">"startUUIDString"</span>);</span><br><span class="line">v23 = objc_retainAutoreleasedReturnValue(v22);</span><br><span class="line">v24 = objc_msgSend(&amp;OBJC_CLASS___NSDate, <span class="string">"date"</span>);</span><br><span class="line">v25 = (<span class="keyword">void</span> *)objc_retainAutoreleasedReturnValue(v24);</span><br><span class="line">objc_msgSend(v25, <span class="string">"timeIntervalSince1970"</span>);</span><br><span class="line">v27 = (<span class="keyword">signed</span> __int64)v26;</span><br><span class="line">objc_release(v25);</span><br><span class="line">objc_msgSend(v9, <span class="string">"setValue:forKey:"</span>, v23, <span class="built_in">CFSTR</span>(<span class="string">"_su"</span>));</span><br><span class="line">v28 = objc_msgSend(&amp;OBJC_CLASS___NSNumber, <span class="string">"numberWithLong:"</span>, v27);</span><br><span class="line">v29 = objc_retainAutoreleasedReturnValue(v28);</span><br><span class="line">objc_msgSend(v9, <span class="string">"setValue:forKey:"</span>, v29, <span class="built_in">CFSTR</span>(<span class="string">"_t"</span>));</span><br><span class="line">objc_release(v29);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="解析-su参数"><a href="#解析-su参数" class="headerlink" title="解析_su参数"></a>解析<code>_su</code>参数</h2><ul>
<li><p>由上可知<code>_su</code>来自于<code>v23</code>,<code>v23</code>来自于<code>+[HLLGlobelManager startUUIDString]</code>，查看方法实现如下。根据经验可知<code>+[NSDate dateStringForTimeInterval:format:]</code>不是iOS自带的方法，猜测是NSDate的分类方法。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">v2 = objc_msgSend(&amp;OBJC_CLASS___NSMutableString, <span class="string">"string"</span>);</span><br><span class="line">v3 = (<span class="keyword">void</span> *)objc_retainAutoreleasedReturnValue(v2);</span><br><span class="line">v4 = objc_msgSend(&amp;OBJC_CLASS___NSDate, <span class="string">"date"</span>);</span><br><span class="line">v5 = (<span class="keyword">void</span> *)objc_retainAutoreleasedReturnValue(v4);</span><br><span class="line">objc_msgSend(v5, <span class="string">"timeIntervalSince1970"</span>);</span><br><span class="line">v6 = objc_msgSend(&amp;OBJC_CLASS___NSDate, <span class="string">"dateStringForTimeInterval:format:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"yyMMddHHmmssSSS"</span>));</span><br><span class="line">v7 = objc_retainAutoreleasedReturnValue(v6);</span><br><span class="line">objc_msgSend(v3, <span class="string">"appendFormat:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"%@"</span>), v7);</span><br><span class="line">objc_release(v7);</span><br><span class="line">objc_release(v5);</span><br><span class="line">objc_msgSend(v3, <span class="string">"appendString:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"2"</span>));</span><br><span class="line">objc_msgSend(v3, <span class="string">"appendString:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"000000"</span>));</span><br><span class="line">v8 = arc4random();</span><br><span class="line">objc_msgSend(v3, <span class="string">"appendFormat:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"%010lld"</span>), v8);</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看<code>+[NSDate dateStringForTimeInterval:format:]</code>伪代码实现</p>
<ul>
<li><p>lldb中执行<code>image lookup -r -s dateStringForTimeInterval:format:</code>，结果显示方法所在的模块是<code>HLLKit</code></p>
</li>
<li><p>把<code>HLLKit</code>的mach-o文件拖进IDA进行分析，伪代码实现如下，经验可知都是iOS自带的方法，不需要往下分析。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+[<span class="built_in">NSDate</span> dateStringForTimeInterval:format:](<span class="built_in">NSDate_meta</span> *<span class="keyword">self</span>, SEL a2, <span class="keyword">double</span> a3, <span class="keyword">id</span> a4)</span><br><span class="line">v4 = a3;</span><br><span class="line">v5 = objc_retain(a4);</span><br><span class="line">v6 = objc_msgSend(&amp;OBJC_CLASS___NSDate, <span class="string">"dateWithTimeIntervalSince1970:"</span>, v4);</span><br><span class="line">v7 = objc_retainAutoreleasedReturnValue(v6);</span><br><span class="line">v8 = objc_msgSend(&amp;OBJC_CLASS___NSDateFormatter, <span class="string">"new"</span>);</span><br><span class="line">v9 = (<span class="keyword">void</span> *)objc_alloc(&amp;OBJC_CLASS___NSLocale);</span><br><span class="line">v10 = objc_msgSend(v9, <span class="string">"initWithLocaleIdentifier:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"en_US_POSIX"</span>));</span><br><span class="line">objc_msgSend(v8, <span class="string">"setLocale:"</span>, v10);</span><br><span class="line">objc_release(v10);</span><br><span class="line">objc_msgSend(v8, <span class="string">"setDateFormat:"</span>, v5);</span><br><span class="line">objc_release(v5);</span><br><span class="line">v11 = objc_msgSend(v8, <span class="string">"stringFromDate:"</span>, v7);</span><br><span class="line">v12 = objc_retainAutoreleasedReturnValue(v11);</span><br><span class="line">objc_release(v8);</span><br><span class="line">objc_release(v7);</span><br><span class="line"><span class="keyword">return</span> (<span class="keyword">id</span>)_objc_autoreleaseReturnValue(v12);</span><br></pre></td></tr></table></figure>
</li>
<li><p>参照上下文，实现如下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSDate</span> (<span class="title">Extension</span>)</span></span><br><span class="line">+ (<span class="built_in">NSString</span> *)dateStringForTimeInterval:(<span class="built_in">NSTimeInterval</span>)timeInterval format:(<span class="built_in">NSString</span> *)format &#123;</span><br><span class="line">   <span class="built_in">NSDate</span> *date = [<span class="built_in">NSDate</span> dateWithTimeIntervalSince1970:timeInterval];</span><br><span class="line">   <span class="built_in">NSDateFormatter</span> *dateFormatter = [<span class="built_in">NSDateFormatter</span> new];</span><br><span class="line">   <span class="built_in">NSLocale</span> *locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">   [dateFormatter setLocale:locale];</span><br><span class="line">   [dateFormatter setDateFormat:format];</span><br><span class="line">   <span class="built_in">NSString</span> *dateString = [dateFormatter stringFromDate:date];</span><br><span class="line">   <span class="keyword">return</span> dateString;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>已经手动实现了<code>+[NSDate dateStringForTimeInterval:format:]</code>，接下来<code>+[HLLGlobelManager startUUIDString]</code>参照上下文实现如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NSString *<span class="title">startUUIDString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    NSMutableString *strM = [NSMutableString <span class="built_in">string</span>];</span><br><span class="line">    NSTimeInterval timeInterval = [[NSDate date] timeIntervalSince1970];</span><br><span class="line">    NSString *dateString = [NSDate dateStringForTimeInterval:timeInterval format:@<span class="string">"yyMMddHHmmssSSS"</span>];</span><br><span class="line">    [strM appendFormat:@<span class="string">"%@"</span>, dateString];</span><br><span class="line">    [strM appendString:@<span class="string">"2"</span>];</span><br><span class="line">    [strM appendFormat:@<span class="string">"000000"</span>];</span><br><span class="line">    [strM appendFormat:@<span class="string">"%010lld"</span>,arc4random()];</span><br><span class="line">    <span class="keyword">return</span> strM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据上面两段代码，整合一下<code>_su</code>生成过程，到这里<code>_su</code>的值已经解析完成。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">NSString *_su() &#123;</span><br><span class="line">  <span class="comment">// 生成dateString</span></span><br><span class="line">  NSTimeInterval timeInterval = [[NSDate date] timeIntervalSince1970];</span><br><span class="line">  NSDate *date = [NSDate dateWithTimeIntervalSince1970:timeInterval];</span><br><span class="line">  NSDateFormatter *dateFormatter = [NSDateFormatter <span class="keyword">new</span>];</span><br><span class="line">  NSLocale *locale = [[NSLocale alloc] initWithLocaleIdentifier:@<span class="string">"en_US_POSIX"</span>];</span><br><span class="line">  [dateFormatter setLocale:locale];</span><br><span class="line">  [dateFormatter setDateFormat: @<span class="string">"yyMMddHHmmssSSS"</span>];</span><br><span class="line">  NSString *dateString = [dateFormatter stringFromDate:date];</span><br><span class="line">  <span class="comment">// 拼接字符串</span></span><br><span class="line">  NSMutableString *strM = [NSMutableString <span class="built_in">string</span>];</span><br><span class="line">  [strM appendFormat:@<span class="string">"%@"</span>, dateString];</span><br><span class="line">  [strM appendString:@<span class="string">"2"</span>];</span><br><span class="line">  [strM appendFormat:@<span class="string">"000000"</span>];</span><br><span class="line">  [strM appendFormat:@<span class="string">"%010lld"</span>,arc4random()];</span><br><span class="line">  <span class="keyword">return</span> strM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="解析-t参数"><a href="#解析-t参数" class="headerlink" title="解析_t参数"></a>解析<code>_t</code>参数</h2><ul>
<li><p>由<code>寻找可变参数</code>部分可知,<code>_t</code>来自于<code>v29</code>,<code>v29</code>来自于<code>v28</code>,<code>v28</code>来自于<code>v27</code>,<code>v27</code>来自于<code>v26</code>,而<code>v26</code>并看不到来源。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">v27 = (<span class="keyword">signed</span> __int64)v26;</span><br><span class="line">...</span><br><span class="line">v28 = objc_msgSend(&amp;OBJC_CLASS___NSNumber, <span class="string">"numberWithLong:"</span>, v27);</span><br><span class="line">v29 = objc_retainAutoreleasedReturnValue(v28);</span><br><span class="line">objc_msgSend(v9, <span class="string">"setValue:forKey:"</span>, v29, <span class="built_in">CFSTR</span>(<span class="string">"_t"</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>伪代码模式下可以发现<code>v26</code>在汇编模式下的值是<code>D0</code>。这个时候鼠标点击到<code>v27 = (signed __int64)v26;</code>这行，按<code>Tab</code>键从伪代码模式切换到汇编模式，得出<code>v26 == D0 == [[NSDate date] timeIntervalSince1970]</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ADRP            X8, #classRef_NSDate@PAGE</span><br><span class="line">LDR             X0, [X8,#classRef_NSDate@PAGEOFF] ; <span class="keyword">void</span> *</span><br><span class="line">ADRP            X8, #selRef_date@PAGE</span><br><span class="line">LDR             X1, [X8,#selRef_date@PAGEOFF] ; <span class="keyword">char</span> *</span><br><span class="line">BL              _objc_msgSend</span><br><span class="line">MOV             X29, X29</span><br><span class="line">BL              _objc_retainAutoreleasedReturnValue</span><br><span class="line">MOV             X23, X0</span><br><span class="line">ADRP            X8, #selRef_timeIntervalSince1970@PAGE</span><br><span class="line">LDR             X1, [X8,#selRef_timeIntervalSince1970@PAGEOFF] ; <span class="keyword">char</span> *</span><br><span class="line">BL              _objc_msgSend</span><br><span class="line">FCVTZS          X24, D0</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>_t</code>实现过程的完整代码为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NSNumber *<span class="keyword">_t</span>() &#123;</span><br><span class="line">  NSTimeInterval timeInterval = [[NSDate date] timeIntervalSince1970];</span><br><span class="line">  NSNumber *number = [NSNumber numberWithLong:(<span class="keyword">signed</span> <span class="keyword">long</span> <span class="keyword">long</span>)timeInterval];</span><br><span class="line">  <span class="keyword">return</span> number;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="解析-sign参数"><a href="#解析-sign参数" class="headerlink" title="解析_sign参数"></a>解析<code>_sign</code>参数</h2><h3 id="查找-sign第一重来源"><a href="#查找-sign第一重来源" class="headerlink" title="查找_sign第一重来源"></a>查找<code>_sign</code>第一重来源</h3><ul>
<li><p><code>_t</code>和<code>_su</code>都已经解析完成，剩下一个<code>_sign</code>。到现在并没有发现<code>_sign</code>的任何线索，怎么办呢？从上可知<code>_t</code>和<code>_su</code>都是通过<code>setValue:forKey:</code>进行赋值的，猜测<code>_sign</code>也是这样赋值的。</p>
</li>
<li><p>当key的值为<code>_sign</code>时，value的值就是需要的，然后往上追索value的来源。条件断点最适合，如下。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">br set -n setValue:forKey: -c '(BOOL)[(NSString *)$x3 containsString:@"_sign"]'</span><br></pre></td></tr></table></figure>
</li>
<li><p>当断点命中时，查看调用堆栈，看value的值来自于哪里。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) bt</span><br><span class="line">* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 4.1</span><br><span class="line">* frame #0: 0x0000000186706660 Foundation` -[NSMutableDictionary(NSKeyValueCoding) setValue:forKey:]</span><br><span class="line">  frame #1: 0x00000001020c2030 HLLKit` __17-[HLLSession GET]_block_invoke  + 216</span><br></pre></td></tr></table></figure>
</li>
<li><p>发现<code>0x00000001020c2030</code>处给value赋值了，所以需要查看这个地址在mach-o文件中的位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(lldb) image lookup -a 0x00000001020c2030</span><br><span class="line">    Address: HLLKit[0x0000000000026030] (HLLKit.__TEXT.__text + 135936)</span><br><span class="line">    Summary: HLLKit`__17-[HLLSession GET]_block_invoke + 216</span><br></pre></td></tr></table></figure>
</li>
<li><p>IDA中按G找到<code>0x0000000000026030</code>处代码，调用<code>signForAllParameters</code>方法生成了value，也就是<code>_sign</code>的值。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">v4 = objc_msgSend(*(<span class="keyword">void</span> **)(v1 + <span class="number">32</span>), <span class="string">"allparameters"</span>);</span><br><span class="line">v5 = (<span class="keyword">void</span> *)objc_retainAutoreleasedReturnValue(v4);</span><br><span class="line">v6 = objc_msgSend(*(<span class="keyword">void</span> **)(v1 + <span class="number">32</span>), <span class="string">"signForAllParameters"</span>);</span><br><span class="line">v7 = objc_retainAutoreleasedReturnValue(v6);</span><br><span class="line">objc_msgSend(v5, <span class="string">"setValue:forKey:"</span>, v7, <span class="built_in">CFSTR</span>(<span class="string">"_sign"</span>));</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="查找-sign第二重来源"><a href="#查找-sign第二重来源" class="headerlink" title="查找_sign第二重来源"></a>查找<code>_sign</code>第二重来源</h3><ul>
<li><p>查看<code>signForAllParameters</code>的伪代码，发现还挺长。精简处理后，保留如下重要的部分。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">v8 = objc_msgSend(&amp;OBJC_CLASS___NSURL, <span class="string">"URLWithString:"</span>, +[HLLSession hostURL]);</span><br><span class="line">v11 = objc_msgSend(&amp;OBJC_CLASS___NSURLComponents, <span class="string">"componentsWithURL:resolvingAgainstBaseURL:"</span>, v8, <span class="number">0</span>LL);</span><br><span class="line">v13 = objc_msgSend(v11, <span class="string">"host"</span>);</span><br><span class="line">v16 = objc_msgSend(</span><br><span class="line">        v13,</span><br><span class="line">        <span class="string">"stringByReplacingOccurrencesOfString:withString:"</span>,</span><br><span class="line">        <span class="built_in">CFSTR</span>(<span class="string">"XXOOmove.net"</span>),</span><br><span class="line">        <span class="built_in">CFSTR</span>(<span class="string">"XXOO.cn"</span>));</span><br><span class="line">v18 = objc_msgSend(</span><br><span class="line">        v16,</span><br><span class="line">        <span class="string">"stringByReplacingOccurrencesOfString:withString:"</span>,</span><br><span class="line">        <span class="built_in">CFSTR</span>(<span class="string">"XXOOmove.com"</span>),</span><br><span class="line">        <span class="built_in">CFSTR</span>(<span class="string">"XXOO.cn"</span>));</span><br><span class="line">v20 = ((<span class="built_in">NSMutableDictionary</span> *(__cdecl *)(HLLSession *, SEL))objc_msgSend)(v2, <span class="string">"allparameters"</span>);</span><br><span class="line">v23 = HLLStringUtil003(v20, v18);</span><br><span class="line"><span class="keyword">return</span> v23;</span><br></pre></td></tr></table></figure>
</li>
<li><p>从上可知核心代码是<code>v23 = HLLStringUtil003(v20, v18);</code>,我们在这行下地址断点，打印x0和x1的值，也就是伪代码中v20和v18的值。(后文把v20的值成为<code>所有参数</code>)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(lldb) image list -o -f | grep HLLKit</span><br><span class="line">[  0] 0x00000001008e8000 /private/var/containers/Bundle/Application/  0C0095F0-160B-4BCA-8D91-F357CF72A295/XXOO.app/Frameworks/HLLKit.framework/HLLKit  (0x00000001008e8000)</span><br><span class="line">(lldb) breakpoint set -a 0x00000001008e8000+0x000000000002817C</span><br><span class="line"></span><br><span class="line">(lldb) po $x0</span><br><span class="line">&#123;</span><br><span class="line">    "_m" = "login_by_pwd";</span><br><span class="line">    "_su" = 20072521323852720000001535952001;</span><br><span class="line">    "_t" = 1595683958;</span><br><span class="line">    args = "&#123;\"password\":\"e10adc3949ba59abbe56e057f20f883e\",\"ref\":\"\",  \"device_id\":\"292126F625BD47CFAB6E44162DCC85CA\",\"city_id\":1002,  \"phone_no\":\"18618618618\",\"device_type\":\"iPhone 6\",  \"idfa\":\"3D506F30-D4D9-49C2-A61E-EC5EF222D475\"&#125;";</span><br><span class="line">    "device_id" = 292126F625BD47CFAB6E44162DCC85CA;</span><br><span class="line">    "device_type" = "iPhone 6";</span><br><span class="line">    os = ios;</span><br><span class="line">    revision = 6446;</span><br><span class="line">    version = "6.4.46";</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(lldb) po $x1</span><br><span class="line">uapi.XXOO.cn</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="查找-sign第三重来源"><a href="#查找-sign第三重来源" class="headerlink" title="查找_sign第三重来源"></a>查找<code>_sign</code>第三重来源</h3><ul>
<li><p>接下来就是查看<code>HLLStringUtil003</code>的实现。伪代码还是很长，截取重要的部分如下。根据上下文可知v5的值是<code>uapi.XXOO.cn</code>，经过各种判断，首先来到<code>v19 = CFSTR(&quot;kZErbmP$XXOO$c0jtQ&amp;ru0s3lGW87&quot;);</code>,然后来到<code>LABEL_25:</code>,最后到<code>LABEL_26:</code>返回值。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)objc_msgSend(v5, <span class="string">"hasSuffix:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"XXOO.cn"</span>)) &amp; <span class="number">1</span></span><br><span class="line">  || (<span class="keyword">unsigned</span> __int64)objc_msgSend(v5, <span class="string">"hasSuffix:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"XXOOmove.net"</span>)) &amp; <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v13 = objc_msgSend(v5, <span class="string">"componentsSeparatedByString:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"."</span>));</span><br><span class="line">  v16 = objc_msgSend(v13, <span class="string">"firstObject"</span>);</span><br><span class="line">  v17 = (<span class="keyword">void</span> *)objc_retainAutoreleasedReturnValue(v16);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)objc_msgSend(v17, <span class="string">"hasPrefix:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"uimg"</span>)) )</span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">LABEL_24:</span><br><span class="line">    objc_release(v40);</span><br><span class="line">LABEL_25:</span><br><span class="line">    v43 = HLLStringUtil102(v3, (__int64)v19);</span><br><span class="line">    v44 = objc_retainAutoreleasedReturnValue(v43);</span><br><span class="line">    v41 = objc_retain(v44, v45);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">v23 = objc_msgSend([<span class="built_in">NSBundle</span> mainBundle], <span class="string">"bundleIdentifier"</span>);</span><br><span class="line">v24 = (__CFString *)objc_retainAutoreleasedReturnValue(v23);</span><br><span class="line"><span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)objc_msgSend(v24, <span class="string">"isEqualToString:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"com.XXOO.driver"</span>)) &amp; <span class="number">1</span></span><br><span class="line">    || (<span class="keyword">unsigned</span> __int64)objc_msgSend(v24, <span class="string">"isEqualToString:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"cn.XXOO.ltldriver"</span>)) &amp; <span class="number">1</span></span><br><span class="line">    || (<span class="keyword">unsigned</span> <span class="keyword">int</span>)objc_msgSend(v24, <span class="string">"isEqualToString:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"com.XXOOmove.global.driver.india"</span>)) )</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)objc_msgSend(v24, <span class="string">"isEqualToString:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"com.XXOO.user"</span>))</span><br><span class="line">      || (<span class="keyword">unsigned</span> <span class="keyword">int</span>)objc_msgSend(v24, <span class="string">"isEqualToString:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"com.XXOOmove.client.india"</span>)) )</span><br><span class="line">  &#123;</span><br><span class="line">      v19 = <span class="built_in">CFSTR</span>(<span class="string">"kZErbmP$XXOO$c0jtQ&amp;ru0s3lGW87"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LABEL_11:</span><br><span class="line">  v40 = v24;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">LABEL_26:</span><br><span class="line">  <span class="keyword">return</span> _objc_autoreleaseReturnValue(v41);</span><br></pre></td></tr></table></figure>
</li>
<li><p>上面分析可知<code>v43 = HLLStringUtil102(v3, (__int64)v19);</code>，这句代码就是我们下步要探索的。使用LLDB打印，发现参数v3就是<code>所有参数</code>，v19我们也在上面求过了。(下文把v19称为<code>签名key</code>)。进去<code>HLLStringUtil102</code>后发现伪代码超长，有400多行。先看第一个需要跳转的地方，LLDB中打印<code>objc_msgSend(v16, &quot;count&quot;)</code>的返回值为0，所以跳转到<code>LABEL_26:</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">v17 = <span class="number">0</span>LL;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)objc_msgSend(v16, <span class="string">"count"</span>) &lt;= v17 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">  v18 = objc_msgSend(v16, <span class="string">"objectAtIndexedSubscript:"</span>, v17);</span><br><span class="line">  v19 = (<span class="keyword">void</span> *)objc_retainAutoreleasedReturnValue(v18);</span><br><span class="line">  v20 = objc_msgSend(v19, <span class="string">"rangeOfString:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"application-identifier"</span>));</span><br><span class="line">  objc_release(v19);</span><br><span class="line">  ++v17;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( v20 == (<span class="keyword">void</span> *)<span class="number">0x7FFFFFFFFFFFFFFF</span>LL );</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据上下文可知v3的值是<code>所有参数</code>的值，<code>[allKeyes count]</code>肯定不为空，所以<code>LABEL_26:</code>直接跳过不执行。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">LABEL_26:</span><br><span class="line">  <span class="keyword">if</span> ( !v3</span><br><span class="line">    || (v47 = objc_msgSend(v3, <span class="string">"allKeys"</span>),</span><br><span class="line">        v48 = (<span class="keyword">void</span> *)objc_retainAutoreleasedReturnValue(v47),</span><br><span class="line">        v49 = objc_msgSend(v48, <span class="string">"count"</span>),</span><br><span class="line">        objc_release(v48),</span><br><span class="line">        !v49) )</span><br><span class="line">  &#123;</span><br><span class="line">    v72 = <span class="number">0</span>LL;</span><br><span class="line">LABEL_44:</span><br><span class="line">    v66 = v113;</span><br><span class="line">    v46 = v115;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_45;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>跳过<code>LABEL_26:</code>代码后就会来到下面代码(代码经过精简的)。看着挺长的，其实就是对allkeys首先进行排序，然后通过key取出value，对key和value进行拼接。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">v53 = objc_msgSend([allparameters allKeys], <span class="string">"sortedArrayUsingComparator:"</span>, &amp;__block_literal_global_19);</span><br><span class="line">v116 = objc_msgSend(&amp;OBJC_CLASS___NSMutableString, <span class="string">"string"</span>);</span><br><span class="line">v58 = objc_msgSend(v53, <span class="string">"countByEnumeratingWithState:objects:count:"</span>, &amp;v120, &amp;v128, <span class="number">16</span>LL);</span><br><span class="line"><span class="keyword">if</span> ( v58 )</span><br><span class="line">&#123;</span><br><span class="line">  v59 = v58;</span><br><span class="line">  v60 = *v122;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v61 = <span class="number">0</span>LL;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v122 != v60 )</span><br><span class="line">        objc_enumerationMutation(v119);</span><br><span class="line">      v62 = *(_QWORD *)(v121 + <span class="number">8</span> * v61);</span><br><span class="line">      <span class="keyword">if</span> ( !((<span class="keyword">unsigned</span> __int64)objc_msgSend(*(<span class="keyword">void</span> **)(v121 + <span class="number">8</span> * v61), <span class="string">"hasPrefix:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"__"</span>)) &amp; <span class="number">1</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v63 = objc_msgSend(v118, <span class="string">"objectForKey:"</span>, v62);</span><br><span class="line">        v64 = (<span class="keyword">void</span> *)objc_retainAutoreleasedReturnValue(v63);</span><br><span class="line">        v65 = objc_msgSend(&amp;OBJC_CLASS___NSData, <span class="string">"class"</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !((<span class="keyword">unsigned</span> __int64)objc_msgSend(v64, <span class="string">"isKindOfClass:"</span>, v65) &amp; <span class="number">1</span>) )</span><br><span class="line">          objc_msgSend(v116, <span class="string">"appendFormat:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"%@%@"</span>), v62, v64);</span><br><span class="line">        objc_release(v64);</span><br><span class="line">      &#125;</span><br><span class="line">      ++v61;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v61 &lt; (<span class="keyword">unsigned</span> __int64)v59 );</span><br><span class="line">    v59 = objc_msgSend(v119, <span class="string">"countByEnumeratingWithState:objects:count:"</span>, &amp;v120, &amp;v128, <span class="number">16</span>LL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v59 );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自己实现上面代码,后文把最终结果称为<code>keyValueStr</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// allParameters是上文`所有参数`的值</span></span><br><span class="line"><span class="built_in">NSMutableString</span> *keyValueStr = [<span class="built_in">NSMutableString</span> string];</span><br><span class="line"><span class="built_in">NSArray</span> *allKeys= [[allParameters allKeys] sortedArrayUsingComparator:^<span class="built_in">NSComparisonResult</span>(<span class="keyword">id</span>  _Nonnull obj1, <span class="keyword">id</span>  _Nonnull obj2) &#123;</span><br><span class="line">    <span class="keyword">return</span> [obj1 compare:obj2];</span><br><span class="line">&#125;];</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSString</span> *key <span class="keyword">in</span> allKeys) &#123;</span><br><span class="line">    <span class="keyword">id</span> value =  [allParameters objectForKey:key];</span><br><span class="line">    <span class="keyword">if</span> (![key hasPrefix:<span class="string">@"__"</span>] &amp;&amp; ![value isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        [keyValueStr appendFormat:<span class="string">@"%@%@"</span>, key, value];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"最终的值为%@"</span>, keyValueStr);</span><br></pre></td></tr></table></figure>
</li>
<li><p>上面的代码执行完成后，会来到如下代码。根据上下文可知v113就是<code>签名key</code>，v116就是<code>keyValueStr</code>，这两个值上文已经求出，直接进行字符串拼接就得到v70的值。v70进行md5就得到v109的值，也就是最终我们要求出的值。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)objc_msgSend(v113, <span class="string">"isEqualToString:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"kZErbmP$XXOO$c0jtQ&amp;ru0s3lGW87"</span>)) &amp; <span class="number">1</span></span><br><span class="line">  || (<span class="keyword">unsigned</span> <span class="keyword">int</span>)objc_msgSend(v113, <span class="string">"isEqualToString:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"P8P$XXOO&amp;fKox3uT#lq3a6YN!jBmMlBYw4"</span>)) )</span><br><span class="line">&#123;</span><br><span class="line">  v70 = objc_msgSend(&amp;OBJC_CLASS___NSString, <span class="string">"stringWithFormat:"</span>, <span class="built_in">CFSTR</span>(<span class="string">"%@%@%@"</span>), v113, v116, v113);</span><br><span class="line">  v71 = (<span class="keyword">struct</span> objc_object *)objc_retainAutoreleasedReturnValue(v70);</span><br><span class="line">&#125; <span class="keyword">else</span> </span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">v109 = ((<span class="keyword">id</span> (__cdecl *)(HLLMD5_meta *, SEL, <span class="keyword">id</span>, <span class="keyword">signed</span> __int64, <span class="keyword">bool</span>))objc_msgSend)(</span><br><span class="line">         (HLLMD5_meta *)&amp;OBJC_CLASS___HLLMD5,</span><br><span class="line">         <span class="string">"md5ForString:bit:uppercase:"</span>,</span><br><span class="line">         v71,</span><br><span class="line">         <span class="number">32</span>LL,</span><br><span class="line">         <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据上面代码可知对v70进行md5，生成32位的大写字符串。所以<code>[HLLMD5 md5ForString:bit:uppercase:]</code>不用往下深究，直接给出代码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NSString *<span class="title">stringToMD5String</span><span class="params">(NSString *<span class="built_in">string</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *cStr = [<span class="built_in">string</span> UTF8String];</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> digest[CC_MD5_DIGEST_LENGTH];</span><br><span class="line">  CC_MD5(cStr, (CC_LONG)<span class="built_in">strlen</span>(cStr), digest);</span><br><span class="line">  NSMutableString *result = [NSMutableString stringWithCapacity:CC_MD5_DIGEST_LENGTH * <span class="number">2</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CC_MD5_DIGEST_LENGTH; i++) &#123;</span><br><span class="line">      [result appendFormat:@<span class="string">"%02X"</span>, digest[i]];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> [result uppercaseString];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后来个大总结,串一下刚才上面的分析，要不然显得有些凌乱。</p>
<ul>
<li><code>_sign</code>来自于<code>-[HLLSession signForAllParameters]</code></li>
<li><code>-[HLLSession signForAllParameters]</code>来自于<code>HLLStringUtil003</code></li>
<li><code>HLLStringUtil003</code>来自于<code>HLLStringUtil102</code></li>
<li>而<code>HLLStringUtil102</code>实现在上面已经说过了，这里把代码整合一下。(为了简单都写成C函数)。<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NSString *<span class="title">getMD5FromString</span><span class="params">(NSString *<span class="built_in">string</span>, BOOL uppercase)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *cStr = [<span class="built_in">string</span> UTF8String];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> digest[CC_MD5_DIGEST_LENGTH];</span><br><span class="line">    CC_MD5(cStr, (CC_LONG)<span class="built_in">strlen</span>(cStr), digest);</span><br><span class="line">    NSMutableString *result = [NSMutableString stringWithCapacity:CC_MD5_DIGEST_LENGTH * <span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CC_MD5_DIGEST_LENGTH; i++) &#123;</span><br><span class="line">        [result appendFormat:@<span class="string">"%02X"</span>, digest[i]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uppercase ? [result uppercaseString] : [result lowercaseString];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">NSString *<span class="title">getKeyValueStrFromAllParameters</span><span class="params">(NSDictionary *allParameters)</span> </span>&#123;</span><br><span class="line">    NSMutableString *keyValueStr = [NSMutableString <span class="built_in">string</span>];</span><br><span class="line">    NSArray *allKeys= [[allParameters allKeys] sortedArrayUsingComparator:^NSComparisonResult(id  _Nonnull obj1, id  _Nonnull obj2) &#123;</span><br><span class="line">        <span class="keyword">return</span> [obj1 compare:obj2];</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">for</span> (NSString *key in allKeys) &#123;</span><br><span class="line">        id value =  [allParameters objectForKey:key];</span><br><span class="line">        <span class="keyword">if</span> (![key hasPrefix:@<span class="string">"__"</span>] &amp;&amp; ![value isKindOfClass:[NSData class]]) &#123;</span><br><span class="line">            [keyValueStr appendFormat:@<span class="string">"%@%@"</span>, key, value];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> keyValueStr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// key就是上文的`签名key`,allParameters就是上的`所有参数`</span></span><br><span class="line">NSString *_sign(NSDictionary *allParameters, NSString *key) &#123;</span><br><span class="line">    NSString *keyValueStr = getKeyValueStrFromAllParameters(allParameters);</span><br><span class="line">    NSString *lastStr = [NSString stringWithFormat:@<span class="string">"%@%@%@"</span>,key,keyValueStr,key];</span><br><span class="line">    NSString *sign = getMD5FromString(lastStr, YES);</span><br><span class="line">    <span class="keyword">return</span> sign;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>到此三个可变参数<code>_sign</code>、<code>_su</code>、<code>_t</code>都解析完成。</p>
</li>
</ul>
<h2 id="解析args参数"><a href="#解析args参数" class="headerlink" title="解析args参数"></a>解析<code>args</code>参数</h2><ul>
<li>从抓包截图可知args参数还没有解析，只不过它不是可变的，所以我们放在最后进行解析。args的值是json字符串，根据经验可知，它的原始类型是NSDictionary。</li>
<li>password是32位的小写字符串，猜测是对用户输入密码就行md5加密，<a href="https://www.cmd5.com/" target="_blank" rel="noopener">验证一下</a>，证明了猜想。</li>
<li><code>ref</code>、<code>device_id</code>、<code>city_id</code>、<code>device_type</code>、<code>idfa</code>直接写死就可以，<code>phone_no</code>来自于用户输入的手机号</li>
<li>终上所述，生成args的代码为<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">NSString *phoneNo = @<span class="string">"18618618618"</span>;</span><br><span class="line">NSString *password = getMD5FromString(@<span class="string">"123456"</span>, NO);</span><br><span class="line">NSString *deviceId = @<span class="string">"292126F625BD47CFAB6E44162DCC85CA"</span>;</span><br><span class="line">NSString *deviceType =  @<span class="string">"iPhone 6"</span>;</span><br><span class="line"><span class="comment">// 生成args</span></span><br><span class="line">NSMutableDictionary *argsDict = [NSMutableDictionary dictionary];</span><br><span class="line">argsDict[@<span class="string">"password"</span>] = password;</span><br><span class="line">argsDict[@<span class="string">"ref"</span>] = @<span class="string">""</span>;</span><br><span class="line">argsDict[@<span class="string">"device_id"</span>] = deviceId;</span><br><span class="line">argsDict[@<span class="string">"city_id"</span>] = @<span class="string">"1002"</span>;</span><br><span class="line">argsDict[@<span class="string">"phone_no"</span>] = phoneNo;</span><br><span class="line">argsDict[@<span class="string">"device_type"</span>] = deviceType;</span><br><span class="line">argsDict[@<span class="string">"idfa"</span>] = @<span class="string">"3D506F30-D4D9-49C2-A61E-EC5EF222D47"</span>;</span><br><span class="line">NSData *argsData = [NSJSONSerialization dataWithJSONObject:argsDict options:<span class="number">0</span> error:nil];</span><br><span class="line"><span class="comment">// 最终结果</span></span><br><span class="line">NSString *argsStr = [[NSString alloc] initWithData:argsData encoding:NSUTF8StringEncoding];</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="发起登录请求"><a href="#发起登录请求" class="headerlink" title="发起登录请求"></a>发起登录请求</h2><ul>
<li><p>api接口使用的是https协议，所以有两种方式进行访问。本文简单起见，用的是tweak项目</p>
<ul>
<li>直接新建tweak项目，直接访问。</li>
<li>新建Xcode项目，从ipa解压包中找到访问https的cer证书，然后在NSURLSession代理方法中加载cer证书，证书验证通过后，就可以访问了。</li>
</ul>
</li>
<li><p>封装的方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;CommonCrypto/CommonDigest.h&gt;</span></span></span><br><span class="line"><span class="comment">// 获取_su参数</span></span><br><span class="line"><span class="built_in">NSString</span> *_su() &#123;</span><br><span class="line">    <span class="comment">// 生成dateString</span></span><br><span class="line">    <span class="built_in">NSTimeInterval</span> timeInterval = [[<span class="built_in">NSDate</span> date] timeIntervalSince1970];</span><br><span class="line">    <span class="built_in">NSDate</span> *date = [<span class="built_in">NSDate</span> dateWithTimeIntervalSince1970:timeInterval];</span><br><span class="line">    <span class="built_in">NSDateFormatter</span> *dateFormatter = [<span class="built_in">NSDateFormatter</span> new];</span><br><span class="line">    <span class="built_in">NSLocale</span> *locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@"en_US_POSIX"</span>];</span><br><span class="line">    [dateFormatter setLocale:locale];</span><br><span class="line">    [dateFormatter setDateFormat: <span class="string">@"yyMMddHHmmssSSS"</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *dateString = [dateFormatter stringFromDate:date];</span><br><span class="line">    <span class="comment">// 拼接字符串</span></span><br><span class="line">    <span class="built_in">NSMutableString</span> *strM = [<span class="built_in">NSMutableString</span> string];</span><br><span class="line">    [strM appendFormat:<span class="string">@"%@"</span>, dateString];</span><br><span class="line">    [strM appendString:<span class="string">@"2"</span>];</span><br><span class="line">    [strM appendFormat:<span class="string">@"000000"</span>];</span><br><span class="line">    [strM appendFormat:<span class="string">@"%010u"</span>,arc4random()];</span><br><span class="line">    <span class="keyword">return</span> strM;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取_t参数</span></span><br><span class="line"><span class="built_in">NSNumber</span> *_t() &#123;</span><br><span class="line">    <span class="built_in">NSTimeInterval</span> timeInterval = [[<span class="built_in">NSDate</span> date] timeIntervalSince1970];</span><br><span class="line">    <span class="built_in">NSNumber</span> *number = [<span class="built_in">NSNumber</span> numberWithLong:(<span class="keyword">signed</span> <span class="keyword">long</span> <span class="keyword">long</span>)timeInterval];</span><br><span class="line">    <span class="keyword">return</span> number;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取字符串的md5值</span></span><br><span class="line"><span class="built_in">NSString</span> *getMD5FromString(<span class="built_in">NSString</span> *string, <span class="built_in">BOOL</span> uppercase) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *cStr = [string UTF8String];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> digest[CC_MD5_DIGEST_LENGTH];</span><br><span class="line">    CC_MD5(cStr, (CC_LONG)strlen(cStr), digest);</span><br><span class="line">    <span class="built_in">NSMutableString</span> *result = [<span class="built_in">NSMutableString</span> stringWithCapacity:CC_MD5_DIGEST_LENGTH * <span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CC_MD5_DIGEST_LENGTH; i++) &#123;</span><br><span class="line">        [result appendFormat:<span class="string">@"%02X"</span>, digest[i]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uppercase ? [result uppercaseString] : [result lowercaseString];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取keyValueStr</span></span><br><span class="line"><span class="built_in">NSString</span> *getKeyValueStrFromAllParameters(<span class="built_in">NSDictionary</span> *allParameters) &#123;</span><br><span class="line">    <span class="built_in">NSMutableString</span> *keyValueStr = [<span class="built_in">NSMutableString</span> string];</span><br><span class="line">    <span class="built_in">NSArray</span> *allKeys= [[allParameters allKeys] sortedArrayUsingComparator:^<span class="built_in">NSComparisonResult</span>(<span class="keyword">id</span>  _Nonnull obj1, <span class="keyword">id</span>  _Nonnull obj2) &#123;</span><br><span class="line">        <span class="keyword">return</span> [obj1 compare:obj2];</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *key <span class="keyword">in</span> allKeys) &#123;</span><br><span class="line">        <span class="keyword">id</span> value =  [allParameters objectForKey:key];</span><br><span class="line">        <span class="keyword">if</span> (![key hasPrefix:<span class="string">@"__"</span>] &amp;&amp; ![value isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            [keyValueStr appendFormat:<span class="string">@"%@%@"</span>, key, value];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> keyValueStr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取_sign值</span></span><br><span class="line"><span class="built_in">NSString</span> *_sign(<span class="built_in">NSDictionary</span> *allParameters, <span class="built_in">NSString</span> *key) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *keyValueStr = getKeyValueStrFromAllParameters(allParameters);</span><br><span class="line">    <span class="built_in">NSString</span> *lastStr = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@%@%@"</span>,key,keyValueStr,key];</span><br><span class="line">    <span class="built_in">NSString</span> *sign = getMD5FromString(lastStr, <span class="literal">YES</span>);</span><br><span class="line">    <span class="keyword">return</span> sign;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 把NSDictionary参数转化为query字符串</span></span><br><span class="line"><span class="built_in">NSString</span> *getStrFromDict(<span class="built_in">NSDictionary</span> *dict) &#123;</span><br><span class="line">    <span class="built_in">NSMutableString</span> *strM = [<span class="built_in">NSMutableString</span> string];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dict.allKeys.count; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i != <span class="number">0</span>) [strM appendString:<span class="string">@"&amp;"</span>];</span><br><span class="line">        <span class="built_in">NSString</span> *key = dict.allKeys[i];</span><br><span class="line">        <span class="built_in">NSString</span> *value = dict[key];</span><br><span class="line">        [strM appendFormat:<span class="string">@"%@=%@"</span>,key,value];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> strM;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取args参数</span></span><br><span class="line"><span class="built_in">NSString</span> *getArgsStr(<span class="built_in">NSString</span> *phoneNo, <span class="built_in">NSString</span> *password, <span class="built_in">NSString</span> *deviceId, <span class="built_in">NSString</span> *deviceType ) &#123;</span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *argsDict = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    argsDict[<span class="string">@"password"</span>] = getMD5FromString(password, <span class="literal">NO</span>);</span><br><span class="line">    argsDict[<span class="string">@"ref"</span>] = <span class="string">@""</span>;</span><br><span class="line">    argsDict[<span class="string">@"device_id"</span>] = deviceId;</span><br><span class="line">    argsDict[<span class="string">@"city_id"</span>] = <span class="string">@"1002"</span>;</span><br><span class="line">    argsDict[<span class="string">@"phone_no"</span>] = phoneNo;</span><br><span class="line">    argsDict[<span class="string">@"device_type"</span>] = deviceType;</span><br><span class="line">    argsDict[<span class="string">@"idfa"</span>] = <span class="string">@"3D506F30-D4D9-49C2-A61E-EC5EF222D47"</span>;</span><br><span class="line">    <span class="built_in">NSData</span> *argsData = [<span class="built_in">NSJSONSerialization</span> dataWithJSONObject:argsDict options:<span class="number">0</span> error:<span class="literal">nil</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *argsStr = [[<span class="built_in">NSString</span> alloc] initWithData:argsData encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="keyword">return</span> argsStr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>tweak中进行访问。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">%hook PasswordLoginVC</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)login &#123;</span><br><span class="line">   <span class="comment">// 登录手机号</span></span><br><span class="line">	 <span class="built_in">NSString</span> *phoneNo = <span class="string">@"18618618618"</span>; </span><br><span class="line">   <span class="comment">// 登录密码</span></span><br><span class="line">   <span class="built_in">NSString</span> *password = <span class="string">@"123456"</span>; </span><br><span class="line">   <span class="built_in">NSString</span> *deviceId = <span class="string">@"292126F625BD47CFAB6E44162DCC85CA"</span>;</span><br><span class="line">   <span class="built_in">NSString</span> *deviceType =  <span class="string">@"iPhone 6"</span>;</span><br><span class="line">   <span class="comment">// 生成args</span></span><br><span class="line">   <span class="built_in">NSString</span> *args = getArgsStr(phoneNo, password, deviceId, deviceType);</span><br><span class="line">   <span class="comment">// query参数</span></span><br><span class="line">   <span class="built_in">NSMutableDictionary</span> *queryDict = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">   queryDict[<span class="string">@"_m"</span>] = <span class="string">@"login_by_pwd"</span>;</span><br><span class="line">   queryDict[<span class="string">@"_su"</span>] = _su();</span><br><span class="line">   queryDict[<span class="string">@"_t"</span>] = _t();</span><br><span class="line">   queryDict[<span class="string">@"args"</span>] = args;</span><br><span class="line">   queryDict[<span class="string">@"device_id"</span>] = deviceId;</span><br><span class="line">   queryDict[<span class="string">@"device_type"</span>] = deviceType;</span><br><span class="line">   queryDict[<span class="string">@"os"</span>] = <span class="string">@"ios"</span>;</span><br><span class="line">   queryDict[<span class="string">@"revision"</span>] = <span class="string">@"6446"</span>;</span><br><span class="line">   queryDict[<span class="string">@"version"</span>] = <span class="string">@"6.4.46"</span>;</span><br><span class="line">   queryDict[<span class="string">@"_sign"</span>] = _sign(queryDict, <span class="string">@"kZErbmP$XXOO$c0jtQ&amp;ru0s3lGW87"</span>);</span><br><span class="line">   <span class="comment">// 得到最终参数后进行转义</span></span><br><span class="line">   <span class="built_in">NSString</span> *queryStr = getStrFromDict(queryDict);</span><br><span class="line">	 queryStr = [queryStr stringByAddingPercentEncodingWithAllowedCharacters: [<span class="built_in">NSCharacterSet</span> URLQueryAllowedCharacterSet]];</span><br><span class="line">   <span class="comment">// 进行请求</span></span><br><span class="line">   <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString: [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"https://uapi.XXOO.cn?%@"</span>,queryStr]];</span><br><span class="line">   <span class="built_in">NSMutableURLRequest</span> *request = [<span class="built_in">NSMutableURLRequest</span> requestWithURL:url];</span><br><span class="line">   request.HTTPMethod = <span class="string">@"GET"</span>;</span><br><span class="line">   [[[<span class="built_in">NSURLSession</span> sharedSession] dataTaskWithRequest:request completionHandler:^(<span class="built_in">NSData</span> * _Nullable data, <span class="built_in">NSURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">       <span class="built_in">NSString</span> *str = [[<span class="built_in">NSString</span> alloc] initWithData:data encoding: <span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">       <span class="built_in">NSLog</span>(<span class="string">@"打印值:%@--%@"</span>,error, str);</span><br><span class="line">   &#125;] resume];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%end</span><br></pre></td></tr></table></figure></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/逆向/" rel="tag"># 逆向</a>
              <a href="/tags/iOS/" rel="tag"># iOS</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/06/08/RemoveSIMAlertWindows/" rel="prev" title="移除SIM卡弹框">
      <i class="fa fa-chevron-left"></i> 移除SIM卡弹框
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/08/15/Weibo/" rel="next" title="逆向微博跳广告和内部打开链接">
      逆向微博跳广告和内部打开链接 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#注意"><span class="nav-number">1.</span> <span class="nav-text">注意</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备"><span class="nav-number">2.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#寻找切入点"><span class="nav-number">3.</span> <span class="nav-text">寻找切入点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#寻找可变参数"><span class="nav-number">4.</span> <span class="nav-text">寻找可变参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解析-su参数"><span class="nav-number">5.</span> <span class="nav-text">解析_su参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解析-t参数"><span class="nav-number">6.</span> <span class="nav-text">解析_t参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解析-sign参数"><span class="nav-number">7.</span> <span class="nav-text">解析_sign参数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查找-sign第一重来源"><span class="nav-number">7.1.</span> <span class="nav-text">查找_sign第一重来源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查找-sign第二重来源"><span class="nav-number">7.2.</span> <span class="nav-text">查找_sign第二重来源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查找-sign第三重来源"><span class="nav-number">7.3.</span> <span class="nav-text">查找_sign第三重来源</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解析args参数"><span class="nav-number">8.</span> <span class="nav-text">解析args参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#发起登录请求"><span class="nav-number">9.</span> <span class="nav-text">发起登录请求</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description">龙龙的技术博客,各种IT知识的聚合</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
